<?xml version="1.0" encoding="UTF-8"?>

<!--
  Copyright 2019, California Institute of Technology ("Caltech").
  U.S. Government sponsorship acknowledged.
  
  All rights reserved.
  
  Redistribution and use in source and binary forms, with or without
  modification, are permitted provided that the following conditions are met:
  
  * Redistributions of source code must retain the above copyright notice,
  this list of conditions and the following disclaimer.
  * Redistributions must reproduce the above copyright notice, this list of
  conditions and the following disclaimer in the documentation and/or other
  materials provided with the distribution.
  * Neither the name of Caltech nor its operating division, the Jet Propulsion
  Laboratory, nor the names of its contributors may be used to endorse or
  promote products derived from this software without specific prior written
  permission.
  
  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
  POSSIBILITY OF SUCH DAMAGE.
-->

<document>
<properties>
  <title>Operation</title>
</properties>

<body>

<section name="Operation Overview">
<p>
The high level architecture of PDS Registry and its main components is shown below.
</p>
<img src="/images/registry-harvest.jpg" width="35%" />
</section>

<!-- ======================================================== -->

<section name="Common Operations">

<subsection name="Extract PDS4 Product Metadata">
<p>
Run Harvest tool to crawl PDS4 products and extract metadata. 
The metadata is stored in an "intermediate" XML file which can be loaded into Solr 
by Registry Manager or Solr post tool.
</p>
<p>
In addition to some basic information, such as lid, vid, product class, internal references, 
file name and size, you can configure additional fields to export.
Optionally the whole PDS product labels can be stored as BLOBs (Binary Large OBjects).
</p>
<p>
See <a href="/operate/harvest.html">Harvest Documentation</a> for more information.
</p>
</subsection>

<subsection name="Create or Delete Registry Collection">
<p>
You must create registry collection in Solr, before loading data generated by Harvest tool.
See <a href="/install/registry.html">Registry Installation</a> and 
<a href="/operate/reg-manager.html">Registry Manager</a> for more information.
</p>
<p>
You may want to add more fields to default schema or change default Solr configuration.
See <a href="/operate/reg-collection.html">Registry Collection Configuration</a> and
<a href="https://lucene.apache.org/solr/guide/documents-fields-and-schema-design.html" target="_blank">Solr Documentation</a>
for more information.
</p>
</subsection>

<subsection name="Load Metadata into Solr">
<p>
Intermediate XML file generated by Harvest, can be loaded into Solr 
by <a href="/operate/reg-manager.html">Registry Manager</a> or standard 
<a href="/operate/solr-tools.html">Solr tools</a>, such as Solr post tool. 
</p>
<p>
The following example shows how to load data with Registry Manager. 
<source>
registry-manager load-data -filePath /home/pds/harvest/solr/solr-docs.xml
</source>
</p>
</subsection>

<!-- ============================================================= -->

<subsection name="View / Search Metadata">

<h4>Solr Admin UI</h4>
<p>
To search registry collection in <a href="/operate/solr-tools.html">Solr Admin UI</a> open 
the following URL in a browser <i>http://localhost:8983/solr</i>, select <i>registry</i>
collection from a dropdown and then <i>Query</i> menu item.
</p>
<img src="/images/solr-search-ui.jpg" width="80%" />

<h4>Solr Search API</h4>

<p>
You can find more information about Solr Search API at 
<a href="https://lucene.apache.org/solr/guide/8_4/json-request-api.html" target="_blank">Solr web site</a>.
</p>
<p>
To call old API, either open the following URL in a browser or use <i>curl</i> command:
<source>
curl "http://localhost:8983/solr/registry/query?q=*:*"
</source>
To call new JSON Search API you have to use <i>curl</i> command:
<source>
curl "http://localhost:8983/solr/registry/query" -d '{ "query" : "*:*" }'
</source>
</p>
</subsection>

<!-- ============================================================= -->

<subsection name="Delete Metadata from Solr">
<p>
You can use <a href="/operate/reg-manager.html">Registry Manager</a> tool to delete metadata 
by lidvid, lid, package id (Harvest run id), or to delete all data. Few examples are shown below.
<source>
registry-manager delete-data -lidvid urn:nasa:pds:context:target:asteroid.4_vesta::1.1
registry-manager delete-data -lid urn:nasa:pds:context:target:asteroid.4_vesta
registry-manager delete-data -packageId 8d8ae96d-044e-473d-a278-62635b1c5977
registry-manager delete-data -all
</source>
</p>

<p>
You can also delete data from Solr by calling Solr update API 
<source>
$ curl 'http://localhost:8983/solr/registry/update/' --data-binary "&lt;delete&gt;&lt;query&gt;*:*&lt;/query&gt;&lt;/delete&gt;"
</source>
</p>
</subsection>

<!-- ============================================================= -->

<subsection name="Reingest Data to Registry">
<p>
Registry collection uses lidvid as a primary key. If you load data multiple times, 
old documents will be replaced by new documents with the same lidvid.
To avoid any orphan records, you may want to delete old documents first.
</p>
</subsection>

<!-- ============================================================= -->

<subsection name="Export a File from Registry BLOB">
<p>
If PDS product label BLOBs (Binary Large OBjects) were generated by Harvest, they can be exported 
by <a href="/operate/reg-manager.html">Registry Manager</a> tool as shown below.
<source>
registry-manager export-file -lidvid urn:nasa:pds:context:target:asteroid.4_vesta::1.1 -filePath /tmp/4_vesta.xml
</source>
</p>

</subsection>

</section>

</body>
</document>
